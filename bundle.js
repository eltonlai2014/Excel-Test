"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var lodash=_interopDefault(require("lodash")),log4js=_interopDefault(require("log4js")),exceljs=_interopDefault(require("exceljs")),canvas=_interopDefault(require("canvas"));class DrawLib{drawString(t,e,a,l,i,r,o,s,h,n){s=s||"#000000",n=n||"bottom",h=h||"left",r=r||"Arial",o=o||"",t.save(),t.fillStyle=s,t.font=o+" "+i+"pt "+r,t.textAlign=h,t.textBaseline=n,a=Math.round(a),l=Math.round(l),t.fillText(e,a,l);s=t.measureText(e).width;return t.restore(),s}drawBgString(t,e,a,l,i,r,o,s,h,n,g){h=h||"#999999",t.font=(o=o||"")+" "+i+"pt "+r;var c=t.measureText(e).width,C=t.measureText("Ag").emHeightAscent,u=(a=Math.round(a),(l=Math.round(l))-C-3),C=C+3;return t.beginPath(),"right"==n?t.rect(a-c-2,u,c+4,C):"left"==n?t.rect(a-2,u,c+4,C):t.rect(a-2-c/2,u,c+4,C),t.fillStyle=h,t.fill(),this.drawString(t,e,a,l,i,r,o,s,n,g)+4}drawBgStringRoundRect(t,e,a,l,i,r,o,s,h,n,g){h=h||"#999999",t.font=(o=o||"")+" "+i+"pt "+r;var c=t.measureText(e).width,C=t.measureText("Ag").emHeightAscent,u=(a=Math.round(a),(l=Math.round(l))-C-3),C=C+3;return t.beginPath(),"right"==n?this.drawRoundRect(t,a-c-2,u,c+4,C,4,!0,h):"left"==n?this.drawRoundRect(t,a-2,u,c+4,C,4,!0,h):this.drawRoundRect(t,a-2-c/2,u,c+4,C,4,!0,h),t.fillStyle=h,t.fill(),this.drawString(t,e,a,l,i,r,o,s,n,g)+4}drawRoundRect(t,e,a,l,i,r,o,s,h,n){void 0===h&&(h=!1),void 0===o&&(o=!1),void 0===r&&(r=4),n=n||1,e=Math.round(e),a=Math.round(a),t.save(),t.translate(.5,.5),t.beginPath(),t.moveTo(e+r,a),t.lineTo(e+l-r,a),t.quadraticCurveTo(e+l,a,e+l,a+r),t.lineTo(e+l,a+i-r),t.quadraticCurveTo(e+l,a+i,e+l-r,a+i),t.lineTo(e+r,a+i),t.quadraticCurveTo(e,a+i,e,a+i-r),t.lineTo(e,a+r),t.quadraticCurveTo(e,a,e+r,a),t.lineWidth=n,t.closePath(),h&&t.stroke(),o&&(t.fillStyle=s,t.fill()),t.restore()}dashedLineTo(t,e,a,l,i,r,o,s){s=s||[3,3],t.save(),t.setLineDash(s),this.clearLineTo(t,e,a,l,i,r,o),t.restore()}clearLineTo(t,e,a,l,i,r,o){o=o||1,r=r||"#000000",t.save(),t.translate(.5,.5),e=Math.round(e),a=Math.round(a),l=Math.round(l),i=Math.round(i),t.beginPath(),t.moveTo(e,a),t.lineTo(l,i),t.lineWidth=o,t.strokeStyle=r,t.stroke(),t.restore()}drawLineNoAliasing(e,a,l,t,i,r){r=r||"#FFFFFF";var o=this.DBP(a,l,t,i),s=this.getAngle(t-a,i-l);e.save(),e.fillStyle=r;for(let t=0;t<o;t++)e.fillRect(Math.round(a+Math.cos(s)*t),Math.round(l+Math.sin(s)*t),1,1);e.restore()}drawRectEx(t,e,a,l,i,r,o){this.clearLineTo(t,e,a,e+l,a,r,o),this.clearLineTo(t,e+l,a,e+l,a+i,r,o),this.clearLineTo(t,e+l,a+i,e,a+i,r,o),this.clearLineTo(t,e,a+i,e,a,r,o)}fillRectEx(t,e,a,l,i,r){t.beginPath(),t.rect(Math.round(e),Math.round(a),Math.round(l),Math.round(i)),t.fillStyle=r,t.fill(),t.closePath()}getPrettyUnit(t,e){var a=Math.pow(10,Math.floor(Math.log10(t))),l=Math.pow(10,Math.ceil(Math.log10(t)));return l<=10?t<4.5*a?l/2:l:1.1*t/a<=(e=e||7.5)?Math.ceil(1.1*t/a)*a-a/2:l}quickSort(a){if(a.length<=1)return a;var t=Math.floor(a.length/2),l=a.splice(t,1)[0],i=[],r=[];for(let t=0,e=a.length;t<e;t++)(a[t]<l?i:r).push(a[t]);return this.quickSort(i).concat([l],this.quickSort(r))}DBP(t,e,a,l){return Math.sqrt((a-t)*(a-t)+(l-e)*(l-e))}getAngle(t,e){return Math.atan(e/(0===t?.01:t))+(t<0?Math.PI:0)}getMonthWeek(t,e,a){t=new Date(t,parseInt(e,10)-1,a),e=t.getDay(),a=t.getDate();return Math.ceil((a+6-e)/7)}getYearWeek(t,e,a){e=new Date(t,parseInt(e)-1,a),a=new Date(t,0,1),t=Math.round((e.valueOf()-a.valueOf())/864e5);return Math.floor((t+a.getDay())/7)}rgbToHex(t,e,a){return"#"+((1<<24)+(t<<16)+(e<<8)+a).toString(16).slice(1)}hexToRgb(t){t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}setChartData(t){console.log("CommonChart setChartData ...")}}var DrawLib_1=DrawLib;const logger=log4js.getLogger("CommonChart"),{createCanvas,loadImage}=canvas;class CommonChart extends DrawLib_1{constructor(t,e,a){super(),this.cWidth=t,this.cHeight=e,this.init(a)}init(t){logger.info("CommonChart init"),this.leftWidth=t.leftWidth||50,this.rightWidth=t.rightWidth||20,this.chartWidth=this.cWidth-this.leftWidth-this.rightWidth,this.topHeight=t.topHeight||50,this.bottomHeight=t.bottomHeight||20,this.chartHeight=this.cHeight-this.topHeight-this.bottomHeight,this.canvas=createCanvas(this.cWidth,this.cHeight),this.context=this.canvas.getContext("2d")}getChartInfo(){return this.chartWidth+" "+this.chartHeight}getCanvasBuffer(t){return this.canvas.toBuffer(t=t||"image/png")}setChartData(t){console.log("CommonChart setChartData ...")}}var CommonChart_1=CommonChart;const logger$1=log4js.getLogger("SiteChart");class SiteChart extends CommonChart_1{constructor(t,e,a){super(t,e,a),this.myInit(a)}myInit(t){logger$1.info("SiteChart init"),this.chartColor=t.chartColor||["#5B9BD5","#ED7D31","#A5A5A5","#FFC000","#229B2F","#6495ED"],this.chartLineWidth=t.chartLineWidth||4}setChartData(t,e){e=e||SiteChart.Type.COMPANY,logger$1.info("SiteChart setChartData ..."),super.setChartData(t),this.chartData=t.data,this.chartTitle=t.title;for(let t=this.maxValue=0;t<this.chartData.length;t++){var a=this.chartData[t];e==SiteChart.Type.COMPANY?(a.Total=a.Health+a.Warning+a.Critical,this.maxValue=Math.max(this.maxValue,a.Total)):e==SiteChart.Type.SITES&&(this.maxValue=Math.max(this.maxValue,a.Warning),this.maxValue=Math.max(this.maxValue,a.Critical))}return this.chartData=lodash.sortBy(this.chartData,["Month"]),console.log("data",this.chartData,this.maxValue),this.axisY_Max=this.getPrettyUnit(this.maxValue),this}getChartInfo(){console.log(this.leftWidth,this.chartWidth,this.rightWidth),console.log(this.topHeight,this.chartHeight,this.bottomHeight)}paint(e){logger$1.info("SiteChart paint ..."),e=e||["Health","Warning","Critical","Total"],this.getChartInfo();var r="#ffffff",o=this.context,t=(o.fillStyle=r,o.fillRect(0,0,this.cWidth,this.cHeight),"#AAAAAA"),a=(this.clearLineTo(o,0,0,this.cWidth,0,t,1),this.clearLineTo(o,0,this.cHeight-1,this.cWidth,this.cHeight-1,t,1),this.clearLineTo(o,0,0,0,this.cHeight-1,t,1),this.clearLineTo(o,this.cWidth-1,0,this.cWidth-1,this.cHeight-1,t,1),this.chartTitle&&this.drawString(o,this.chartTitle,this.cWidth/2,this.topHeight/2+4,16,"Arial","","#333333","center","middle"),"#CCCCCC"),s=(this.clearLineTo(o,this.leftWidth-1,this.topHeight,this.leftWidth-1,this.topHeight+this.chartHeight,a,1),this.clearLineTo(o,this.leftWidth-1,this.topHeight+this.chartHeight,this.cWidth-this.rightWidth,this.topHeight+this.chartHeight,a,1),"Arial"),h="#333333";for(let t=0;t<5;t++){const S=this.topHeight+t*this.chartHeight/5;0<t&&this.clearLineTo(o,this.leftWidth-1,S,this.cWidth-this.rightWidth,S,a,1),this.drawString(o,(5-t)*this.axisY_Max/5,this.leftWidth-4,S,10,s,"",h,"right","middle")}this.drawString(o,"0",this.leftWidth-4,this.topHeight+this.chartHeight+2,10,s,"",h,"right","bottom"),this.drawString(o,"Sites",this.leftWidth-4,this.topHeight+this.chartHeight+18,10,s,"",h,"right","top"),o.save();var n=this.chartWidth/this.chartData.length;for(let i=0;i<e.length;i++){var g=e[i];if(1==this.chartData.length){var l=this.chartData[0],c=this.chartWidth/(e.length+2),C=this.leftWidth+(i+1.5)*c,u=l[g]/this.axisY_Max*this.chartHeight;this.fillRectEx(o,C-.3*c,this.topHeight+this.chartHeight,.6*c,-u,this.chartColor[i%this.chartColor.length]);const S=this.topHeight+this.chartHeight-u-4;this.drawBgString(o,l[g],C,S,10,s,"",h,r,"center","bottom"),0==i&&this.drawString(o,l.Month,this.leftWidth+this.chartWidth/2,this.topHeight+this.chartHeight+18,10,s,"",h,"center","top")}else{let e=null,a=null;for(let t=0;t<this.chartData.length;t++){var v=this.chartData[t],p=this.leftWidth+(t+.5)*n,v=this.topHeight+(this.axisY_Max-v[g])/this.axisY_Max*this.chartHeight;null!=e&&null!=a&&this.clearLineTo(o,e,a,p,v,this.chartColor[i%this.chartColor.length],this.chartLineWidth),e=p,a=v}let l=!1;6<this.chartData.length&&(l=!0);for(let e=0;e<this.chartData.length;e++){var d=this.chartData[e],f=this.leftWidth+(e+.5)*n,m=this.topHeight+(this.axisY_Max-d[g])/this.axisY_Max*this.chartHeight;let t=-4;if(i%2==0&&(t=20),this.drawBgString(o,d[g],f,m+t,10,s,"",this.chartColor[i%this.chartColor.length],r,"center","bottom"),0==i){let t=d.Month.toString();l&&6==t.length&&(t=t.substring(4)),this.drawString(o,t,f,this.topHeight+this.chartHeight+18,10,s,"",h,"center","top")}}}}let S=this.cHeight-16;for(let t=0;t<e.length;t++){var i=this.leftWidth+this.chartWidth/e.length*t;this.drawString(o,e[t],i+30+4,S,10,s,"",h,"left","moddle"),this.fillRectEx(o,i,S-6-2,30,6,this.chartColor[t])}return o.restore(),this}}SiteChart.Type={},SiteChart.Type.COMPANY=0,SiteChart.Type.SITES=1;var SiteChart_1=SiteChart;const logger$2=log4js.getLogger("ReportExcel");class ReportExcel{constructor(t){this.options=t}getParamValue(t,e){return null!=this.options[t]?this.options[t]:e}genReport(st){const ht=(t,e,a,l,i,r)=>{t=t.getCell(a);return t.style=e%2==0?i:r,t.value=l=null==l?"":l,t},nt=(t,e,a,l)=>{t=t.getCell(e);return t.style=l,t.value=a,t},gt=e=>{var a={};for(let t=0;t<e.RankList.length;t++){var l=e.RankList[t].EventType,i=e.RankList[t].Rank;a[l]=i}return a},ct=(t,e,a)=>{let l=t[e];return null!=(l=null==l?[]:l)[a]?l[a]:{SiteId:"",SiteName:""}};return new Promise(async(L,O)=>{this.report=st,logger$2.info("ReportExcel init",this.options);let t=11;var e=this.getParamValue("OperationBlock",!0),a=this.getParamValue("NetworkDeviceBlock",!0),P=this.getParamValue("CriticalEventBlock",!0),_=this.getParamValue("WarningEventBlock",!0),l=(e&&(t+=16+st.reportData.data.length),a&&(t+=16+st.reportData2.data.length),P&&(t+=41),_&&(t+=41),this.workbook=new exceljs.Workbook,await this.workbook.xlsx.readFile(this.options.StyleFile),this.workbook.getWorksheet(this.options.StyleSheet)),i=new SiteChart_1(this.options.chartOptions.chartWidth||540,this.options.chartOptions.chartHeight||300,this.options.chartOptions),I=[];for(let t=1;t<=20;t++){var F=l.getColumn(t);I.push(F.width)}console.log("colWidth",I);var V=l.getCell("B1").style,G=l.getCell("B2").style,r=l.getCell("H3").style,Y=l.getCell("C7").style,o=l.getCell("C12").style,j=(l.getCell("F12").style,l.getCell("C23").style,l.getCell("C24").style),q=l.getCell("D23").style,s=l.getCell("D24").style,h=l.getCell("C52").style,n=l.getCell("D52").style,g=l.getCell("C53").style,c=l.getCell("D53").style,C=l.getCell("C54").style,u=l.getCell("D54").style,v=this.workbook.addWorksheet("台電測試站",{pageSetup:{paperSize:12}});for(let t=1;t<=20;t++)v.getColumn(t).width=I[t-1];var X=t+1;for(let t=1;t<=200;t++){var z=v.getRow(t);for(let t=1;t<=20;t++)z.getCell(t).style=V;if(1<t&&t<X)for(let t=2;t<=14;t++)z.getCell(t).style=G}let p=3,d=v.getRow(p),f=d.getCell(8);f.value="公司報表_台電",f.style=r,f.font=r.font;for(let t=p+=2;t<p+5;t++){var U=v.getRow(t);for(let t=3;t<=13;t++)U.getCell(t).style=Y;switch(t){case p+1:v.mergeCells(`C${t}:F`+t),U.getCell(3).value="  公司　"+st.companyName;break;case p+2:v.mergeCells(`C${t}:F`+t),U.getCell(3).value="  報表產生時間　"+st.reportDate;break;case p+3:v.mergeCells(`C${t}:F`+t),U.getCell(3).value=`  報告內容時間　${st.reportSDate}~`+st.reportEate}}if(p=p+5+2,e){d=v.getRow(p),v.mergeCells(`C${p}:M`+p),(f=d.getCell(3)).value="站台營運服務狀態",f.style=o;var r=p+1,J=["  各站台 MXview 主機營運狀況","  以是否發生 MXview One Server Alert 區分","  Critical Site  當月發生過 Critical Event","  Warning Site  當月未發生Critical Event 但有 Warning Event","  Health Site  當月未發生 Critical Event 和 Warning Event"];for(let t=p+=2;t<p+7;t++){var K=v.getRow(t);for(let t=3;t<=7;t++)K.getCell(t).style=Y;switch(t){case p+1:case p+2:case p+3:case p+4:case p+5:v.mergeCells(`C${t}:G`+t),K.getCell(3).value=J[t-p-1]}}p=p+7+2;var Q=["","Health Site","Warning Site","Critical Site","Total"];for(let t=0;t<st.reportData.data.length;t++){var Z=st.reportData.data[t];Z.Total=Z.Health+Z.Warning+Z.Critical}st.reportData.data=lodash.sortBy(st.reportData.data,["Month"]);for(let t=p;t<=p+(st.reportData.data.length+1);t++){var m=v.getRow(t);if(t===p)for(let t=0;t<5;t++){var tt=m.getCell(t+3);tt.value=Q[t],tt.style=q}else{var S=st.reportData.data[t-p-1];if(S){let t=m.getCell(3);t.style=j,t.value=S.Month,(t=m.getCell(4)).style=s,t.value=S.Health,(t=m.getCell(5)).style=s,t.value=S.Warning,(t=m.getCell(6)).style=s,t.value=S.Critical,(t=m.getCell(7)).style=s,t.value=S.Total}}}i.setChartData(st.reportData,SiteChart_1.Type.COMPANY).paint();const ot=i.getCanvasBuffer();e=this.workbook.addImage({buffer:ot,extension:"png"});v.addImage(e,{tl:{col:7.5,row:r},ext:{width:this.options.chartOptions.chartWidth,height:this.options.chartOptions.chartHeight}}),p=p+st.reportData.data.length+5}if(a){d=v.getRow(p),v.mergeCells(`C${p}:M`+p),(f=d.getCell(3)).value="站台網路及設備監控狀態",f.style=o;var e=p+1,et=["  各站台網路及設備狀況","  以是否發生 MXview One Server Alert 之外的 Alert 區分","  Critical Site  當月發生過 Critical Event","  Warning Site  當月未發生Critical Event 但有 Warning Event","  Health Site  當月未發生 Critical Event 和 Warning Event"];for(let t=p+=2;t<p+7;t++){var at=v.getRow(t);for(let t=3;t<=7;t++)at.getCell(t).style=Y;switch(t){case p+1:case p+2:case p+3:case p+4:case p+5:v.mergeCells(`C${t}:G`+t),at.getCell(3).value=et[t-p-1]}}p=p+7+2;var lt=["","Health Site","Warning Site","Critical Site","Total"];for(let t=0;t<st.reportData2.data.length;t++){var it=st.reportData2.data[t];it.Total=it.Health+it.Warning+it.Critical}st.reportData2.data=lodash.sortBy(st.reportData2.data,["Month"]);for(let t=p;t<=p+(st.reportData2.data.length+1);t++){var y=v.getRow(t);if(t===p)for(let t=0;t<5;t++){var rt=y.getCell(t+3);rt.value=lt[t],rt.style=q}else{var w=st.reportData2.data[t-p-1];if(w){let t=y.getCell(3);t.style=j,t.value=w.Month,(t=y.getCell(4)).style=s,t.value=w.Health,(t=y.getCell(5)).style=s,t.value=w.Warning,(t=y.getCell(6)).style=s,t.value=w.Critical,(t=y.getCell(7)).style=s,t.value=w.Total}}}i.setChartData(st.reportData2,SiteChart_1.Type.COMPANY).paint();r=i.getCanvasBuffer(),a=this.workbook.addImage({buffer:r,extension:"png"});v.addImage(a,{tl:{col:7.5,row:e},ext:{width:this.options.chartOptions.chartWidth,height:this.options.chartOptions.chartHeight}}),p=p+st.reportData2.data.length+5}if(P){var D=gt(st.reportData3);d=v.getRow(p),v.mergeCells(`C${p}:M`+p),(f=d.getCell(3)).value="Critical Event 發生次數 Top 10",f.style=o;for(let t=p+=2;t<=p+10;t++){var W,T=v.getRow(t);t==p?(nt(T,3,"Site",h),nt(T,4,"Total",n),nt(T,6,"Site",h),nt(T,7,"Device unreachable",n),nt(T,9,"Site",h),nt(T,10,"Network alert",n),nt(T,12,"Site",h),nt(T,13,"Ethernet port alert",n)):(W=ct(D,99,t-p-1),ht(T,t-p,3,W.SiteName,C,g),ht(T,t-p,4,W.Times,u,c),W=ct(D,1,t-p-1),ht(T,t-p,6,W.SiteName,C,g),ht(T,t-p,7,W.Times,u,c),W=ct(D,2,t-p-1),ht(T,t-p,9,W.SiteName,C,g),ht(T,t-p,10,W.Times,u,c),W=ct(D,3,t-p-1),ht(T,t-p,12,W.SiteName,C,g),ht(T,t-p,13,W.Times,u,c))}for(let t=p+=13;t<=p+10;t++){var k,x=v.getRow(t);t==p?(nt(x,3,"Site",h),nt(x,4,"Fiber port alert",n),nt(x,6,"Site",h),nt(x,7,"Power supply alert",n),nt(x,9,"Site",h),nt(x,10,"Network intrusion alert",n),nt(x,12,"Site",h),nt(x,13,"Device security alert",n)):(k=ct(D,4,t-p-1),ht(x,t-p,3,k.SiteName,C,g),ht(x,t-p,4,k.Times,u,c),k=ct(D,5,t-p-1),ht(x,t-p,6,k.SiteName,C,g),ht(x,t-p,7,k.Times,u,c),k=ct(D,6,t-p-1),ht(x,t-p,9,k.SiteName,C,g),ht(x,t-p,10,k.Times,u,c),k=ct(D,7,t-p-1),ht(x,t-p,12,k.SiteName,C,g),ht(x,t-p,13,k.Times,u,c))}for(let t=p+=13;t<=p+10;t++){var M,R=v.getRow(t);t==p?(nt(R,3,"Site",h),nt(R,4,"Device Status Alert",n),nt(R,6,"Site",h),nt(R,7,"MXview One Server Alert",n),nt(R,9,"Site",h),nt(R,10,"GOOSE",n)):(M=ct(D,8,t-p-1),ht(R,t-p,3,M.SiteName,C,g),ht(R,t-p,4,M.Times,u,c),M=ct(D,9,t-p-1),ht(R,t-p,6,M.SiteName,C,g),ht(R,t-p,7,M.Times,u,c),M=ct(D,10,t-p-1),ht(R,t-p,9,M.SiteName,C,g),ht(R,t-p,10,M.Times,u,c))}p+=13}if(_){var H=gt(st.reportData4);d=v.getRow(p),v.mergeCells(`C${p}:M`+p),(f=d.getCell(3)).value="Warning Event 發生次數 Top 10",f.style=o;for(let t=p+=2;t<=p+10;t++){var E,b=v.getRow(t);t==p?(nt(b,3,"Site",h),nt(b,4,"Total",n),nt(b,6,"Site",h),nt(b,7,"Device unreachable",n),nt(b,9,"Site",h),nt(b,10,"Network alert",n),nt(b,12,"Site",h),nt(b,13,"Ethernet port alert",n)):(E=ct(H,99,t-p-1),ht(b,t,3,E.SiteName,C,g),ht(b,t,4,E.Times,u,c),E=ct(H,1,t-p-1),ht(b,t,6,E.SiteName,C,g),ht(b,t,7,E.Times,u,c),E=ct(H,2,t-p-1),ht(b,t,9,E.SiteName,C,g),ht(b,t,10,E.Times,u,c),E=ct(H,3,t-p-1),ht(b,t,12,E.SiteName,C,g),ht(b,t,13,E.Times,u,c))}for(let t=p+=13;t<=p+10;t++){var N,B=v.getRow(t);t==p?(nt(B,3,"Site",h),nt(B,4,"Fiber port alert",n),nt(B,6,"Site",h),nt(B,7,"Power supply alert",n),nt(B,9,"Site",h),nt(B,10,"Network intrusion alert",n),nt(B,12,"Site",h),nt(B,13,"Device security alert",n)):(N=ct(H,4,t-p-1),ht(B,t,3,N.SiteName,C,g),ht(B,t,4,N.Times,u,c),N=ct(H,5,t-p-1),ht(B,t,6,N.SiteName,C,g),ht(B,t,7,N.Times,u,c),N=ct(H,6,t-p-1),ht(B,t,9,N.SiteName,C,g),ht(B,t,10,N.Times,u,c),N=ct(H,7,t-p-1),ht(B,t,12,N.SiteName,C,g),ht(B,t,13,N.Times,u,c))}for(let t=p+=13;t<=p+10;t++){var $,A=v.getRow(t);t==p?(nt(A,3,"Site",h),nt(A,4,"Device Status Alert",n),nt(A,6,"Site",h),nt(A,7,"MXview One Server Alert",n),nt(A,9,"Site",h),nt(A,10,"GOOSE",n)):($=ct(H,8,t-p-1),ht(A,t,3,$.SiteName,C,g),ht(A,t,4,$.Times,u,c),$=ct(H,9,t-p-1),ht(A,t,6,$.SiteName,C,g),ht(A,t,7,$.Times,u,c),$=ct(H,10,t-p-1),ht(A,t,9,$.SiteName,C,g),ht(A,t,10,$.Times,u,c))}p+=13}d=v.getRow(p),(f=d.getCell(3)).value="==========================================================================================",console.log("startRow",p),this.workbook.removeWorksheet(l.id);const ot=await this.workbook.xlsx.writeBuffer();L(ot)})}async getReportBuffer(){return null!=this.workbook?await this.workbook.xlsx.writeBuffer():null}}var ReportExcel_1=ReportExcel;const logger$3=log4js.getLogger("ReportExcel");class ReportExcelSite{constructor(t){this.options=t}getParamValue(t,e){return null!=this.options[t]?this.options[t]:e}genReport(st){const ht=(t,e,a,l,i,r)=>{t=t.getCell(a);return t.style=e%2==0?i:r,t.value=l=null==l?"":l,t},nt=(t,e,a,l)=>{t=t.getCell(e);return t.style=l,t.value=a,t};return new Promise(async(L,O)=>{this.report=st,logger$3.info("ReportExcel init",this.options);let t=11;var e=this.getParamValue("OperationBlock",!0),a=this.getParamValue("NetworkDeviceBlock",!0),l=this.getParamValue("EventTypeBlock",!0),i=this.getParamValue("EventRankBlock",!0),r=this.getParamValue("WarningEventBlock",!0),o=(e&&(t+=16+st.reportData.data.length),a&&(t+=16+st.reportData2.data.length),(l||i)&&(t+=17),r&&(t+=41),this.workbook=new exceljs.Workbook,await this.workbook.xlsx.readFile(this.options.StyleFile),this.workbook.getWorksheet(this.options.StyleSheet)),r=new SiteChart_1(this.options.chartOptions.chartWidth||540,this.options.chartOptions.chartHeight||300,this.options.chartOptions),s=[];for(let t=1;t<=20;t++){var P=o.getColumn(t);s.push(P.width)}console.log("colWidth",s);var _=o.getCell("B1").style,I=o.getCell("B2").style,h=o.getCell("H3").style,n=o.getCell("C7").style,g=o.getCell("C13").style,c=(o.getCell("F13").style,o.getCell("C23").style,o.getCell("C24").style),C=o.getCell("D23").style,u=o.getCell("D24").style,v=o.getCell("C53").style,F=o.getCell("E53").style,V=o.getCell("C63").style,p=o.getCell("E63").style,G=o.getCell("C54").style,d=o.getCell("E54").style,Y=o.getCell("C55").style,f=o.getCell("E55").style,m=o.getCell("G53").style,j=o.getCell("M53").style,q=o.getCell("G64").style,S=o.getCell("M64").style,X=o.getCell("G54").style,z=o.getCell("M54").style,U=o.getCell("G55").style,J=o.getCell("M55").style,y=this.workbook.addWorksheet(st.siteName,{pageSetup:{paperSize:12}});for(let t=1;t<=20;t++)y.getColumn(t).width=s[t-1];var K=t+1;for(let t=1;t<=200;t++){var Q=y.getRow(t);for(let t=1;t<=20;t++)Q.getCell(t).style=_;if(1<t&&t<K)for(let t=2;t<=14;t++)Q.getCell(t).style=I}let w=3,D=y.getRow(w),W=D.getCell(8);W.value="站台報表 _ "+st.siteName,W.style=h,W.font=h.font;for(let t=w+=2;t<w+6;t++){var T=y.getRow(t);for(let t=3;t<=13;t++)T.getCell(t).style=n;switch(t){case w+1:y.mergeCells(`C${t}:F`+t),T.getCell(3).value="  公司　"+st.companyName;break;case w+2:y.mergeCells(`C${t}:F`+t),T.getCell(3).value="  站台　"+st.siteName;break;case w+3:y.mergeCells(`C${t}:F`+t),T.getCell(3).value="  報表產生時間　"+st.reportDate;break;case w+4:y.mergeCells(`C${t}:F`+t),T.getCell(3).value=`  報告內容時間　${st.reportSDate}~`+st.reportEate}}if(w=w+6+2,e){D=y.getRow(w),y.mergeCells(`C${w}:M`+w),(W=D.getCell(3)).value="站台營運服務狀態",W.style=g;var h=w+1,Z=["  以是否發生 MXview One Server Alert 區分","  Critical Site  當月發生過 Critical Event","  Warning Site  當月未發生Critical Event 但有 Warning Event","  Health Site  當月未發生 Critical Event 和 Warning Event"];for(let t=w+=2;t<w+6;t++){var tt=y.getRow(t);for(let t=3;t<=7;t++)tt.getCell(t).style=n;switch(t){case w+1:case w+2:case w+3:case w+4:y.mergeCells(`C${t}:G`+t),tt.getCell(3).value=Z[t-w-1]}}w=w+6+2;var et=["","Warning Event","Critical Event","","Site Status"];for(let t=0;t<st.reportData.data.length;t++){var k=st.reportData.data[t];k.Total=k.Warning+k.Critical}st.reportData.data=lodash.sortBy(st.reportData.data,["Month"]);for(let t=w;t<=w+(st.reportData.data.length+1);t++){var x=y.getRow(t);if(y.mergeCells(`F${t}:G`+t),t===w)for(let t=0;t<5;t++){var at=x.getCell(t+3);at.value=et[t],at.style=C}else{var M=st.reportData.data[t-w-1];if(M){let t=x.getCell(3),e=(t.style=c,t.value=M.Month,(t=x.getCell(4)).style=u,t.value=M.Warning,(t=x.getCell(5)).style=u,t.value=M.Critical,(t=x.getCell(6)).style=u,"Health Site");0<M.Warning&&(e="Warning Site"),0<M.Critical&&(e="Critical Site"),t.value=e}}}r.setChartData(st.reportData,SiteChart_1.Type.SITES).paint(["Warning","Critical"]);const A=r.getCanvasBuffer();e=this.workbook.addImage({buffer:A,extension:"png"});y.addImage(e,{tl:{col:7.5,row:h},ext:{width:this.options.chartOptions.chartWidth,height:this.options.chartOptions.chartHeight}}),w=w+st.reportData.data.length+5}if(a){D=y.getRow(w),y.mergeCells(`C${w}:M`+w),(W=D.getCell(3)).value="站台網路及設備監控狀態",W.style=g;var e=w+1,lt=["  以是否發生 MXview One Server Alert 之外的 Alert 區分","  Critical Site  當月發生過 Critical Event","  Warning Site  當月未發生Critical Event 但有 Warning Event","  Health Site  當月未發生 Critical Event 和 Warning Event"];for(let t=w+=2;t<w+6;t++){var it=y.getRow(t);for(let t=3;t<=7;t++)it.getCell(t).style=n;switch(t){case w+1:case w+2:case w+3:case w+4:y.mergeCells(`C${t}:G`+t),it.getCell(3).value=lt[t-w-1]}}w=w+6+2;var rt=["","Warning Site","Critical Site","","Site Status"];for(let t=0;t<st.reportData2.data.length;t++){var R=st.reportData2.data[t];R.Total=R.Health+R.Warning+R.Critical}st.reportData2.data=lodash.sortBy(st.reportData2.data,["Month"]);for(let t=w;t<=w+(st.reportData2.data.length+1);t++){var H=y.getRow(t);if(y.mergeCells(`F${t}:G`+t),t===w)for(let t=0;t<5;t++){var ot=H.getCell(t+3);ot.value=rt[t],ot.style=C}else{var E=st.reportData2.data[t-w-1];if(E){let t=H.getCell(3),e=(t.style=c,t.value=E.Month,(t=H.getCell(4)).style=u,t.value=E.Warning,(t=H.getCell(5)).style=u,t.value=E.Critical,(t=H.getCell(6)).style=u,"Health Site");0<E.Warning&&(e="Warning Site"),0<E.Critical&&(e="Critical Site"),t.value=e}}}r.setChartData(st.reportData2,SiteChart_1.Type.SITES).paint(["Warning","Critical"]);h=r.getCanvasBuffer(),a=this.workbook.addImage({buffer:h,extension:"png"});y.addImage(a,{tl:{col:7.5,row:e},ext:{width:this.options.chartOptions.chartWidth,height:this.options.chartOptions.chartHeight}}),w=w+st.reportData2.data.length+6}r=w;if(l){let t=y.getRow(w);y.mergeCells(`C${w}:E`+w),(W=t.getCell(3)).value=" 異常事件分類次數",W.style=g;for(let t=w+=2;t<=w+10;t++){var b,N=y.getRow(t);t==w?(nt(N,3,"EventType",v),nt(N,4,"",v),nt(N,5,"Count",F)):(b=st.reportData3.RankList[t-w-1],ht(N,t-w,3,b.EventName,Y,G),ht(N,t-w,4,b.EventName,f,d),ht(N,t-w,5,b.Count,f,d)),y.mergeCells(`C${t}:D`+t)}w+=11,t=y.getRow(w),nt(t,3,"Total",V),nt(t,4,"",p),nt(t,5,st.reportData3.RankTotal,p),y.mergeCells(`C${w}:D`+w),w+=3}if(i){w=r;let t=y.getRow(w);y.mergeCells(`G${w}:M`+w),(W=t.getCell(7)).value=" 異常事件次數 Top 10",W.style=g;for(let t=w+=2;t<=w+10;t++){var B,$=y.getRow(t);t==w?(nt($,7,"Categroy",m),nt($,9,"EventType",m),nt($,13,"Count",j)):(B=st.reportData4.RankList[t-w-1],ht($,t-w,7,B.Categroy,U,X),ht($,t-w,9,B.EventName,U,X),ht($,t-w,13,B.Count,J,z)),y.mergeCells(`G${t}:H`+t),y.mergeCells(`I${t}:L`+t)}w+=11,t=y.getRow(w),nt(t,7,"Total",q),nt(t,9,"",S),nt(t,13,st.reportData4.RankTotal,S),y.mergeCells(`G${w}:H`+w),y.mergeCells(`I${w}:L`+w),w+=3}D=y.getRow(w),(W=D.getCell(3)).value="==========================================================================================",console.log("startRow",w),this.workbook.removeWorksheet(o.id);const A=await this.workbook.xlsx.writeBuffer();L(A)})}async getReportBuffer(){return null!=this.workbook?await this.workbook.xlsx.writeBuffer():null}}var ReportExcelSite_1=ReportExcelSite;exports.ReportExcel=ReportExcel_1,exports.ReportExcelSite=ReportExcelSite_1;
